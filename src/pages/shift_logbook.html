<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Officer's Shift Log Book | GNFC</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="/src/js/tailwind_config.js"></script>
  <link rel="stylesheet" href="/src/css/ios-fonts.css">
  <link rel="stylesheet" href="/src/css/modal-ui.css">
  <script>
    window.activePage = 'shift_logbook_officer';
  </script>
  <style>
    #shift-log-table thead th {
      transition: background-color .18s ease, color .18s ease;
    }

    #shift-log-table thead th:hover {
      background: rgba(255, 255, 255, 0.05);
      color: #ffffff;
    }

    html[data-theme-mode="light"] #shift-log-table thead th:hover {
      background: rgba(15, 23, 42, 0.08);
      color: #0f172a;
    }
  </style>
</head>

<body
  class="bg-dark-bg text-dark-text font-sans h-screen flex overflow-hidden selection:bg-gnfc-blue selection:text-white">

  <script src="/src/js/theme_manager.js"></script>
  <script src="/src/js/sidebar.js"></script>
  <script src="/src/js/header.js"></script>
  <script src="/src/js/elogbook_store.js"></script>
  <div id="sidebar-container"></div>
  <script>
    try { renderSidebar('shift_logbook_officer'); } catch (e) { }
  </script>

  <main class="flex-1 flex flex-col h-screen overflow-hidden">

    <div id="header-container"></div>
    <script>
      try {
        renderHeader({
          title: "Officer's Shift Log Book",
          breadcrumbs: [
            { label: "Technician Log", href: "/src/pages/technician_logbook.html" },
            { label: "Officer Logbook" }
          ],
          backLink: "/src/pages/technician_logbook.html"
        });
      } catch (e) { }
    </script>

    <div class="flex-1 p-3 bg-dark-bg flex flex-col gap-3">
      <section class="bg-dark-panel border border-dark-border rounded-sm p-3 flex flex-col gap-3 shrink-0">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <label class="text-[10px] font-bold text-gnfc-blue uppercase tracking-wide">Time Range</label>
            <div class="flex bg-dark-bg border border-dark-border rounded-sm p-0.5">
              <button id="tab-today" onclick="switchView('today')" type="button"
                class="tab-btn px-4 py-1.5 text-xs font-bold rounded-sm transition-colors">Today</button>
              <button id="tab-prev" onclick="switchView('prev')" type="button"
                class="tab-btn px-4 py-1.5 text-xs font-bold rounded-sm transition-colors">Prev Day</button>
              <button id="tab-weekly" onclick="switchView('weekly')" type="button"
                class="tab-btn px-4 py-1.5 text-xs font-bold rounded-sm transition-colors">Weekly</button>
              <button id="tab-monthly" onclick="switchView('monthly')" type="button"
                class="tab-btn px-4 py-1.5 text-xs font-bold rounded-sm transition-colors">Monthly</button>
            </div>
          </div>

          <button onclick="openAddModal()"
            class="bg-gnfc-blue hover:bg-blue-600 text-white px-3 py-1.5 rounded-sm text-xs font-bold flex items-center gap-1">
            <i class="ph-bold ph-plus"></i> Add Entry
          </button>
        </div>
      </section>

      <section class="bg-dark-panel border border-dark-border rounded-sm flex flex-col overflow-hidden">
        <div class="px-4 py-2 border-b border-dark-border flex justify-between items-center bg-dark-header shrink-0">
          <div class="flex items-center gap-2">
            <i class="ph-fill ph-table text-gnfc-blue"></i>
            <h3 class="text-sm font-bold text-dark-text" id="report-title">Log Report</h3>
            <span class="text-xs text-dark-muted ml-2" id="report-date"></span>
          </div>
          <div class="text-xs font-mono text-dark-muted">
            Count: <span id="record-count" class="text-white font-bold">0</span>
          </div>
        </div>

        <div class="flex-1 overflow-auto">
          <table id="shift-log-table" class="w-full text-left border-collapse">
            <thead>
              <tr
                class="bg-dark-header text-[10px] font-bold text-dark-muted uppercase tracking-wider text-center border-b border-dark-border">
                <th rowspan="2" class="w-10 p-2 border-r border-dark-border">Sr</th>
                <th class="w-24 p-2 border-r border-dark-border border-b border-dark-border">Shift</th>
                <th class="w-32 p-2 border-r border-dark-border border-b border-dark-border">Tag No</th>
                <th rowspan="2" class="p-2 border-r border-dark-border text-center min-w-[280px]">Description</th>
                <th rowspan="2" class="w-32 p-2 border-r border-dark-border">Eng</th>
                <th rowspan="2" class="w-20 p-2 border-r border-dark-border">Status</th>
                <th rowspan="2" class="min-w-[180px] p-2">Remarks</th>
              </tr>
              <tr
                class="bg-dark-header text-[10px] font-bold text-dark-muted uppercase tracking-wider text-center border-b border-dark-border">
                <th class="p-2 border-r border-dark-border">Time</th>
                <th class="p-2 border-r border-dark-border">Type Of Job</th>
              </tr>
            </thead>
            <tbody id="log-table-body" class="text-xs font-mono"></tbody>
          </table>
        </div>
      </section>
    </div>

    <footer
      class="h-8 bg-dark-panel border-t border-dark-border px-4 flex items-center justify-between text-[10px] text-dark-muted uppercase tracking-wider shrink-0">
      <span>GNFC Instrumentation Dept.</span>
      <span>Officer Logbook</span>
    </footer>
  </main>

  <div id="shift-add-overlay" class="gnfc-modal-overlay" aria-hidden="true">
    <div class="gnfc-modal-shell">
      <div class="gnfc-modal-header">
        <h3 class="gnfc-modal-title">Add Officer Entry</h3>
        <button onclick="closeAddModal()" class="gnfc-modal-close"><i class="ph-bold ph-x text-lg"></i></button>
      </div>
      <form id="shift-add-form">
        <div class="gnfc-modal-body gnfc-modal-body--tight">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="gnfc-modal-label">Date</label>
              <input id="add-date" type="date" required class="gnfc-modal-input">
            </div>
            <div>
              <label class="gnfc-modal-label">Shift</label>
              <select id="add-shift" class="gnfc-modal-input">
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
              </select>
            </div>
            <div>
              <label class="gnfc-modal-label">Time</label>
              <input id="add-time" type="text" class="gnfc-modal-input">
            </div>
            <div>
              <label class="gnfc-modal-label">Tag No</label>
              <input id="add-tag" type="text" required class="gnfc-modal-input" placeholder="e.g. PT5087K">
            </div>
            <div>
              <label class="gnfc-modal-label">Type Of Job</label>
              <select id="add-job-type" class="gnfc-modal-input">
                <option>MAINTENANCE</option>
                <option>CALIBRATION</option>
                <option>PM</option>
                <option>BREAKDOWN</option>
              </select>
            </div>
            <div>
              <label class="gnfc-modal-label">Officer</label>
              <input id="add-officer" type="text" required class="gnfc-modal-input" placeholder="Officer name">
            </div>
            <div class="md:col-span-2">
              <label class="gnfc-modal-label">Description</label>
              <textarea id="add-description" rows="4" required class="gnfc-modal-input"
                placeholder="Describe the work"></textarea>
            </div>
            <div>
              <label class="gnfc-modal-label">Status</label>
              <select id="add-status" class="gnfc-modal-input">
                <option value="OVER">OVER</option>
                <option value="PENDING">PENDING</option>
              </select>
            </div>
            <div class="md:col-span-3">
              <label class="gnfc-modal-label">Remarks</label>
              <input id="add-remarks" type="text" class="gnfc-modal-input" placeholder="Optional remarks">
            </div>
          </div>
        </div>
        <div class="gnfc-modal-footer">
          <button type="button" onclick="closeAddModal()"
            class="gnfc-modal-btn gnfc-modal-btn-secondary">Cancel</button>
          <button type="submit" class="gnfc-modal-btn gnfc-modal-btn-primary">Save Entry</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Remark Modal -->
  <div id="remark-overlay" class="gnfc-modal-overlay" aria-hidden="true">
    <div class="gnfc-modal-shell gnfc-modal-shell--medium">
      <div class="gnfc-modal-header">
        <h3 class="gnfc-modal-title">Officer's Log Book (Instrument)</h3>
        <button onclick="closeRemarkModal()" class="gnfc-modal-close">
          <i class="ph-bold ph-x text-lg"></i>
        </button>
      </div>
      <div class="gnfc-modal-body gnfc-modal-body--tight">
        <label class="gnfc-modal-label">Remark By: TESTER</label>
        <textarea id="remark-text" rows="6" class="gnfc-modal-input" placeholder="Enter remarks..."></textarea>
      </div>
      <div class="gnfc-modal-footer">
        <button onclick="closeRemarkModal()" class="gnfc-modal-btn gnfc-modal-btn-secondary">Cancel</button>
        <button onclick="saveRemark()" class="gnfc-modal-btn gnfc-modal-btn-primary">Save</button>
      </div>
    </div>
  </div>

  <script>
    /* ================= DATA STORE (MOCKED FOR DEMO) ================= */

    // Data extracted from the provided images
    const mockData = [
      {
        id: 1, date: '2026-02-11', shift: 'A', time: '6 AM To 8 AM', tagNo: 'HY36502', jobType: 'MAINTENANCE',
        description: 'Open feedback issue, checked and found valve working ok but proxy not proper so same set and stroke check found ok.',
        officer: 'C.K.VARIA', status: 'OVER', remarks: ''
      },
      {
        id: 2, date: '2026-02-10', shift: 'C', time: '11 PM To 3 AM', tagNo: 'LT96028', jobType: 'MAINTENANCE',
        description: 'Process reported LT-96028 was showing sudden increase in level so LT checked and after dropped and its Zero showing found disturb so its Zero Calibration done and LT Boxup done.',
        officer: 'C.K.VARIA', status: 'OVER', remarks: ''
      },
      {
        id: 3, date: '2026-02-10', shift: 'A', time: '6 AM To 2 PM', tagNo: 'LT36353', jobType: 'MAINTENANCE',
        description: 'LT36353 (TDI Ground and 1st floor): Process engineer having doubt on LT as the tank was overflow but LT was showing 1.27%, so checked in DCS but No errors observed. Physically checked its tapping and response in field... (Shortened for view)',
        officer: 'M.D.MODI', status: 'OVER', remarks: ''
      },
      {
        id: 4, date: '2026-02-10', shift: 'C', time: '11 PM To 4 AM', tagNo: 'PT96002B', jobType: 'MAINTENANCE',
        description: 'PT box-up done as per process requirements.',
        officer: 'C.K.VARIA', status: 'OVER', remarks: ''
      },
      {
        id: 5, date: '2026-02-10', shift: 'C', time: '4 AM To 5 AM', tagNo: 'VT36132A', jobType: 'MAINTENANCE',
        description: 'Process reported reading fluctuating so sensor removed and again inserted properly after that found working ok.',
        officer: 'C.K.VARIA', status: 'OVER', remarks: ''
      },
      {
        id: 6, date: '2026-02-10', shift: 'C', time: '10 PM To 12 AM', tagNo: 'HY36255', jobType: 'MAINTENANCE',
        description: 'As per process requirement valve is closed by applying air in spring side.',
        officer: 'C.K.VARIA', status: 'OVER', remarks: ''
      }
    ];

    const tabs = ['today', 'prev', 'weekly', 'monthly'];
    const TAB_ACTIVE_CLASS = 'tab-btn px-4 py-1.5 text-xs font-bold rounded-sm transition-colors bg-dark-panel text-gnfc-orange border border-dark-border shadow-sm';
    const TAB_INACTIVE_CLASS = 'tab-btn px-4 py-1.5 text-xs font-bold rounded-sm transition-colors text-dark-muted hover:text-white hover:bg-dark-header';

    const state = {
      view: 'weekly', // Default to weekly to show the data from images
      plant: 'AA'
    };

    function safeText(value) {
      return String(value ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // Helper to format Date string
    function formatDateFriendly(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-GB', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
    }

    function getRows() {
      // Logic to filter the mock data based on the selected view
      // Note: In a real app this would query the backend/store
      const today = '2026-02-11'; // Fixed to match image date for demo
      const prev = '2026-02-10';

      if (state.view === 'today') return mockData.filter(d => d.date === today);
      if (state.view === 'prev') return mockData.filter(d => d.date === prev);

      // Weekly/Monthly returns everything for this demo
      return mockData.sort((a, b) => new Date(b.date) - new Date(a.date));
    }

    function renderTable() {
      const tbody = document.getElementById('log-table-body');
      const rows = getRows();
      const count = document.getElementById('record-count');
      const reportDate = document.getElementById('report-date');
      const reportTitle = document.getElementById('report-title');

      count.textContent = String(rows.length);

      // Update Title Text
      reportTitle.textContent = state.view === 'today' ? 'Today Log Report'
        : state.view === 'prev' ? 'Prev Day Log Report'
          : state.view === 'weekly' ? 'Weekly Log Report'
            : 'Monthly Log Report';

      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-dark-muted italic border-b border-dark-border">No entries found for this range.</td></tr>';
        return;
      }

      /* ================= GROUPING LOGIC START ================= */
      // If Weekly or Monthly, we want to group by Date
      const isGroupedView = state.view === 'weekly' || state.view === 'monthly';

      let html = '';
      let processedDates = new Set();

      rows.forEach((entry, index) => {

        // 1. Inject Date Header if needed
        if (isGroupedView && !processedDates.has(entry.date)) {
          html += `
             <tr class="date-header-row">
               <td colspan="7">
                 <div class="flex items-center gap-2 border-b border-dark-border px-4 py-1.5 font-bold text-[10px] text-gnfc-orange uppercase">
                   <i class="ph-fill ph-calendar-blank"></i>
                   ${formatDateFriendly(entry.date)}
                 </div>
               </td>
             </tr>
           `;
          processedDates.add(entry.date);
        }

        // 2. Render Row
        const status = String(entry.status || '').toUpperCase();
        const statusBadgeClass = status === 'OVER'
          ? 'bg-gnfc-green/15 text-gnfc-green border border-gnfc-green/30'
          : 'bg-gnfc-orange/15 text-gnfc-orange border border-gnfc-orange/30';

        // Reset serial number logic for display if needed, or keep global index
        const srNo = index + 1;

        html += `
          <tr data-entry-id="${entry.id}" class="log-row-1 transition-colors border-b border-dark-border group">
            <td rowspan="2" class="p-2 text-center text-dark-muted font-mono border-r border-dark-border">${srNo}</td>
            <td class="p-2 text-center font-bold text-dark-text border-r border-dark-border">${safeText(entry.shift)}</td>
            <td class="p-2 font-semibold text-gnfc-blue border-r border-dark-border">${safeText(entry.tagNo)}</td>
            <td rowspan="2" class="p-2 text-dark-text leading-relaxed border-r border-dark-border">${safeText(entry.description)}</td>
            <td rowspan="2" class="p-2 text-dark-text font-bold border-r border-dark-border whitespace-nowrap">${safeText(entry.officer)}</td>
            <td rowspan="2" class="p-2 text-center border-r border-dark-border">
              <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold ${statusBadgeClass}">${safeText(status || 'NA')}</span>
            </td>
            <td rowspan="2" class="p-2 text-center">
              <button onclick="openRemarkModal(${entry.id}, '${safeText(entry.remarks || '')}')" class="text-gnfc-blue hover:text-blue-400 transition-colors">
                <i class="ph-fill ph-note-pencil text-lg"></i>
              </button>
            </td>
          </tr>
          <tr data-entry-id="${entry.id}" class="log-row-2 transition-colors border-b border-dark-border group">
            <td class="p-2 text-center text-[10px] text-dark-muted border-r border-dark-border">${safeText(entry.time)}</td>
            <td class="p-2 text-[10px] border-r border-dark-border">
              <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-bold bg-dark-bg border border-dark-border text-dark-muted">${safeText(entry.jobType)}</span>
            </td>
          </tr>
        `;
      });


      tbody.innerHTML = html;

      // Add hover effect to both rows of each entry
      const allRows = tbody.querySelectorAll('tr[data-entry-id]');
      allRows.forEach(row => {
        const entryId = row.getAttribute('data-entry-id');

        row.addEventListener('mouseenter', () => {
          const matchingRows = tbody.querySelectorAll(`tr[data-entry-id="${entryId}"]`);
          matchingRows.forEach(r => r.classList.add('bg-white/5'));
        });

        row.addEventListener('mouseleave', () => {
          const matchingRows = tbody.querySelectorAll(`tr[data-entry-id="${entryId}"]`);
          matchingRows.forEach(r => r.classList.remove('bg-white/5'));
        });
      });
      /* ================= GROUPING LOGIC END ================= */
    }

    function switchView(view) {
      if (!tabs.includes(view)) return;
      state.view = view;

      tabs.forEach((tab) => {
        const tabEl = document.getElementById(`tab-${tab}`);
        if (!tabEl) return;
        tabEl.className = tab === view ? TAB_ACTIVE_CLASS : TAB_INACTIVE_CLASS;
      });

      renderTable();
    }

    function openAddModal() {
      const overlay = document.getElementById('shift-add-overlay');
      overlay.classList.add('is-open');
      overlay.setAttribute('aria-hidden', 'false');
    }

    function closeAddModal() {
      const overlay = document.getElementById('shift-add-overlay');
      overlay.classList.remove('is-open');
      overlay.setAttribute('aria-hidden', 'true');
    }

    function saveEntry(event) {
      event.preventDefault();
      // Mock save functionality
      alert("Entry saved locally (Mock)");
      closeAddModal();
    }

    // Remark Modal Functions
    let currentRemarkEntryId = null;

    function openRemarkModal(entryId, currentRemark) {
      currentRemarkEntryId = entryId;
      const overlay = document.getElementById('remark-overlay');
      const textarea = document.getElementById('remark-text');
      textarea.value = currentRemark || '';
      overlay.classList.add('is-open');
      overlay.setAttribute('aria-hidden', 'false');
    }

    function closeRemarkModal() {
      const overlay = document.getElementById('remark-overlay');
      overlay.classList.remove('is-open');
      overlay.setAttribute('aria-hidden', 'true');
      currentRemarkEntryId = null;
    }

    function saveRemark() {
      const remarkText = document.getElementById('remark-text').value.trim();

      // Find and update the entry in mockData
      const entry = mockData.find(e => e.id === currentRemarkEntryId);
      if (entry) {
        entry.remarks = remarkText;
        alert('Remark saved successfully!');
        closeRemarkModal();
        renderTable();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('shift-add-form');
      form.addEventListener('submit', saveEntry);

      const overlay = document.getElementById('shift-add-overlay');
      overlay.addEventListener('click', (event) => {
        if (event.target === overlay) {
          closeAddModal();
        }
      });

      const remarkOverlay = document.getElementById('remark-overlay');
      remarkOverlay.addEventListener('click', (event) => {
        if (event.target === remarkOverlay) {
          closeRemarkModal();
        }
      });

      switchView(state.view);
    });
  </script>
  <script src="/src/js/pagination.js"></script>
</body>

</html>