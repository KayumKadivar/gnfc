<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | GNFC E-Logbook</title>
  <link rel="stylesheet" href="/src/css/ios-fonts.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="/src/js/tailwind_config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script>window.activePage = 'dashboard';</script>
  <style>
    /* Animated gradient border for KPI cards */
    .kpi-card {
      position: relative;
      overflow: hidden;
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--kpi-color, #5794F2);
      opacity: 0.8;
      transition: opacity 0.3s;
    }

    .kpi-card:hover::before {
      opacity: 1;
    }

    /* Pulse dot animation */
    @keyframes pulse-dot {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: 0.5;
        transform: scale(1.4);
      }
    }

    .pulse-dot {
      animation: pulse-dot 2s ease-in-out infinite;
    }

    /* Activity timeline */
    .activity-item {
      position: relative;
    }

    .activity-item::before {
      content: '';
      position: absolute;
      left: 15px;
      top: 32px;
      bottom: -12px;
      width: 1px;
      background: var(--app-border, #2c3235);
    }

    .activity-item:last-child::before {
      display: none;
    }

    /* Counter animation */
    .counter-value {
      transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Bar chart animation */
    .chart-bar {
      transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Glassmorphism quick-action */
    .quick-action {
      backdrop-filter: blur(8px);
      transition: all 0.25s ease;
    }

    .quick-action:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    /* Smooth scrollbar */
    .dashboard-scroll::-webkit-scrollbar {
      width: 4px;
    }

    .dashboard-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .dashboard-scroll::-webkit-scrollbar-thumb {
      background: #2c3235;
      border-radius: 4px;
    }

    .dashboard-scroll::-webkit-scrollbar-thumb:hover {
      background: #5794F2;
    }
  </style>
</head>

<body class="bg-dark-bg color-primary font-sans h-screen flex overflow-hidden">

  <script src="/src/js/theme_manager.js"></script>
  <script src="/src/js/sidebar.js"></script>
  <script src="/src/js/elogbook_store.js"></script>
  <div id="sidebar-container"></div>
  <script>renderSidebar('dashboard');</script>

  <main class="flex-1 flex flex-col h-screen overflow-hidden">

    <div id="header-container"></div>
    <script src="/src/js/header.js"></script>
    <script>
      renderHeader({
        title: "Dashboard",
        breadcrumbs: [
          { label: "Dashboard" }
        ],
        backLink: "/index.html"
      });
    </script>

    <!-- ═══════ SCROLLABLE CONTENT ═══════ -->
    <div class="flex-1 overflow-y-auto p-4 bg-dark-bg dashboard-scroll space-y-5">

      <!-- ─── Top Bar: Welcome + Clock ─── -->
      <div class="flex items-center justify-between">
        <div>
          <h2 class="font-18px fw-bold tracking-tight">Good <span id="greeting-time">Morning</span>, Admin
          </h2>
          <p class="font-14px color-label mt-0.5">Plant operations overview for today</p>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2 bg-dark-panel border border-dark-border rounded-md px-3 py-2">
            <i class="ph ph-calendar-blank color-blue"></i>
            <span id="live-date" class="font-14px font-mono fw-bold color-primary">--</span>
          </div>
          <div class="flex items-center gap-2 bg-dark-panel border border-dark-border rounded-md px-3 py-2">
            <i class="ph ph-clock color-orange"></i>
            <span id="live-clock" class="font-14px font-mono fw-bold color-primary tabular-nums">--:--:--</span>
          </div>
        </div>
      </div>

      <!-- ─── KPI STAT CARDS ─── -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">

        <!-- Today Total Jobs -->
        <div
          class="kpi-card bg-dark-panel border border-dark-border rounded-md p-4 hover:border-gnfc-blue/40 transition-all cursor-default"
          style="--kpi-color: #5794F2">
          <div class="flex items-center justify-between mb-3">
            <div class="w-9 h-9 rounded-lg bg-gnfc-blue/10 flex items-center justify-center">
              <i class="ph-fill ph-briefcase text-lg color-blue"></i>
            </div>
            <span class="font-13px fw-bold color-label text-upper ls-wider">Today</span>
          </div>
          <div class="typo-kpi counter-value" id="kpi-total">0</div>
          <p class="font-13px color-label fw-bold mt-1 text-upper ls-wide">Today Total Jobs</p>
        </div>

        <!-- Completed Jobs -->
        <div
          class="kpi-card bg-dark-panel border border-dark-border rounded-md p-4 hover:border-gnfc-green/40 transition-all cursor-default"
          style="--kpi-color: #73BF69">
          <div class="flex items-center justify-between mb-3">
            <div class="w-9 h-9 rounded-lg bg-gnfc-green/10 flex items-center justify-center">
              <i class="ph-fill ph-check-circle text-lg color-green"></i>
            </div>
            <i class="ph-fill ph-checks color-green font-14px"></i>
          </div>
          <div class="typo-kpi counter-value" id="kpi-completed">0</div>
          <p class="font-13px color-label fw-bold mt-1 text-upper ls-wide">Completed Jobs</p>
        </div>

        <!-- ISO Jobs -->
        <div
          class="kpi-card bg-dark-panel border border-dark-border rounded-md p-4 hover:border-gnfc-orange/40 transition-all cursor-default"
          style="--kpi-color: #FF9900">
          <div class="flex items-center justify-between mb-3">
            <div class="w-9 h-9 rounded-lg bg-gnfc-orange/10 flex items-center justify-center">
              <i class="ph-fill ph-certificate text-lg color-orange"></i>
            </div>
            <span class="font-13px fw-bold color-orange bg-gnfc-orange/10 px-1.5 py-0.5 rounded-sm">ISO</span>
          </div>
          <div class="typo-kpi counter-value" id="kpi-iso">0</div>
          <p class="font-13px color-label fw-bold mt-1 text-upper ls-wide">ISO Jobs</p>
        </div>

        <!-- All Pending Jobs -->
        <div
          class="kpi-card bg-dark-panel border border-dark-border rounded-md p-4 hover:border-gnfc-red/40 transition-all cursor-default"
          style="--kpi-color: #F2495C">
          <div class="flex items-center justify-between mb-3">
            <div class="w-9 h-9 rounded-lg bg-gnfc-red/10 flex items-center justify-center">
              <i class="ph-fill ph-warning-circle text-lg color-red"></i>
            </div>
            <i class="ph-fill ph-arrow-down color-red font-14px"></i>
          </div>
          <div class="typo-kpi counter-value" id="kpi-pending">0</div>
          <p class="font-13px color-label fw-bold mt-1 text-upper ls-wide">All Pending Jobs</p>
        </div>
      </div>

      <!-- ─── WEEKLY TRENDS & PLANT STATUS ─── -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

        <!-- Weekly Trends (2/3 width) -->
        <div class="lg:col-span-2 bg-dark-panel border border-dark-border rounded-md shadow-sm p-4 relative">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h3 class="fw-bold font-15px color-blue flex items-center gap-2">
                <i class="ph-fill ph-chart-line-up"></i>
                Weekly Job Trends
              </h3>
              <p class="font-13px color-label mt-0.5">Job creation vs completion over last 7 days</p>
            </div>
            <div class="flex gap-2">
              <span class="flex items-center gap-1 font-13px color-label"><span
                  class="w-2 h-2 rounded-full bg-gnfc-blue"></span> Created</span>
              <span class="flex items-center gap-1 font-13px color-label"><span
                  class="w-2 h-2 rounded-full bg-gnfc-green"></span> Completed</span>
            </div>
          </div>
          <div id="weekly-trends-chart" class="w-full h-[220px]"></div>
        </div>

        <!-- Live Plant Status (1/3 width, vertical list) -->
        <div class="bg-dark-panel border border-dark-border rounded-md shadow-sm p-4 flex flex-col">
          <div class="flex items-center justify-between mb-3 shrink-0">
            <h3 class="fw-bold font-15px color-orange flex items-center gap-2">
              <i class="ph-fill ph-factory"></i>
              Live Plant Status
            </h3>
            <span class="font-13px font-mono color-green animate-pulse">● LIVE</span>
          </div>
          <div class="flex-1 overflow-y-auto pr-1 dashboard-scroll space-y-2" id="live-plant-status-list">
            <!-- JS Populated -->
          </div>
        </div>
      </div>

      <!-- ─── 3-COLUMN LAYOUT: Activity | Distribution | Schedules ─── -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

        <!-- Col 1: Recent Activity -->
        <div class="bg-dark-panel border border-dark-border rounded-md shadow-sm flex flex-col">
          <div class="flex items-center justify-between px-4 py-2.5 border-b border-dark-border shrink-0">
            <h3 class="fw-bold font-15px color-blue flex items-center gap-2">
              <i class="ph-fill ph-pulse"></i>
              Recent Activity
            </h3>
            <span class="font-13px fw-bold color-label text-upper ls-wide">All Plants</span>
          </div>
          <div id="activity-feed" class="p-4 space-y-3 overflow-y-auto max-h-[380px] dashboard-scroll">
            <!-- JS-populated -->
          </div>
        </div>

        <!-- Col 2: Job Distribution -->
        <div class="bg-dark-panel border border-dark-border rounded-md shadow-sm flex flex-col">
          <div class="px-4 py-2.5 border-b border-dark-border shrink-0">
            <h3 class="fw-bold font-15px color-blue flex items-center gap-2">
              <i class="ph-fill ph-chart-pie-slice"></i>
              Job Distribution
            </h3>
          </div>
          <div id="job-distribution-chart" class="p-4 flex items-center justify-center flex-1 min-h-[250px]">
            <!-- ApexChart renders here -->
          </div>
        </div>

        <!-- Col 3: Upcoming Schedules & Quick Actions -->
        <div class="space-y-4">

          <!-- Upcoming Schedules Widget -->
          <div class="bg-dark-panel border border-dark-border rounded-md shadow-sm flex flex-col">
            <div class="px-4 py-2.5 border-b border-dark-border flex justify-between items-center bg-gnfc-blue/5">
              <h3 class="fw-bold font-15px color-blue flex items-center gap-2">
                <i class="ph-fill ph-calendar-check"></i>
                Upcoming PMs
              </h3>
              <span class="font-13px fw-bold color-label">Next 48h</span>
            </div>
            <div id="upcoming-schedules-list" class="p-3 space-y-2">
              <!-- JS Populated -->
            </div>
          </div>

          <!-- Quick Actions (Compact) -->
          <div class="bg-dark-panel border border-dark-border rounded-md shadow-sm">
            <div class="px-4 py-2.5 border-b border-dark-border">
              <h3 class="fw-bold font-15px color-blue flex items-center gap-2">
      </div>

      <!-- ─── FOOTER ─── -->
      <footer class="mt-auto border-t border-dark-border bg-dark-panel/50 py-4 px-6">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
          <div class="text-center md:text-left">
            <p class="font-14px color-label fw-medium">&copy; 2026 GNFC Ltd. <span class="mx-1">&bull;</span>
              Instrumentation Dept.</p>
            <p class="font-13px color-label mt-0.5">E-Logbook Dashboard <span class="opacity-50">v2.4.0</span></p>
          </div>
          <div class="flex items-center gap-6">
            <a href="#" class="font-14px color-label hover-color-blue transition-colors fw-medium">System
              Status</a>
            <a href="#"
              class="font-14px color-label hover-color-blue transition-colors fw-medium">Documentation</a>
            <a href="#" class="font-14px color-label hover-color-blue transition-colors fw-medium">Support</a>
          </div>
        </div>
      </footer>

    </div>
  </main>

  <!-- ═══════ DASHBOARD LOGIC ═══════ -->
  <script>
    (function () {
      'use strict';

      const DEFAULT_PLANTS = [
        'AA', 'AAQM', 'AMM', 'ANIPF', 'ANITDI',
        'ASGP', 'BAGG', 'BOILER', 'CMS', 'CPSU',
        'DM', 'EA', 'FA', 'INST WS', 'M1', 'M2', 'UREA', 'UTIL', 'DCS', 'MF'
      ];

      const PLANT_DISPLAY = {
        'AA': { label: 'AA Section', status: 'Operational', color: '#73BF69' },
        'AAQM': { label: 'AAQM', status: 'Operational', color: '#73BF69' },
        'AMM': { label: 'Ammonia', status: 'Operational', color: '#73BF69' },
        'ANIPF': { label: 'ANIPF', status: 'Maintenance', color: '#FF9900' },
        'ANITDI': { label: 'ANITDI', status: 'Operational', color: '#73BF69' },
        'ASGP': { label: 'ASGP', status: 'Operational', color: '#73BF69' },
        'BAGG': { label: 'Bagging', status: 'Operational', color: '#73BF69' },
        'BOILER': { label: 'BOILER', status: 'Critical', color: '#F2495C' },
        'CMS': { label: 'CMS', status: 'Operational', color: '#73BF69' },
        'CPSU': { label: 'CPSU', status: 'Operational', color: '#73BF69' },
        'DM': { label: 'DM Plant', status: 'Operational', color: '#73BF69' },
        'EA': { label: 'EA', status: 'Operational', color: '#73BF69' },
        'FA': { label: 'FA Section', status: 'Operational', color: '#73BF69' },
        'INST WS': { label: 'Inst W/S', status: 'Active', color: '#5794F2' },
        'M1': { label: 'Methanol-1', status: 'Operational', color: '#73BF69' },
        'M2': { label: 'Methanol-2', status: 'Maintenance', color: '#FF9900' },
        'UREA': { label: 'Urea', status: 'Operational', color: '#73BF69' },
        'UTIL': { label: 'Utility', status: 'Operational', color: '#73BF69' },
        'DCS': { label: 'DCS', status: 'Active', color: '#5794F2' },
        'MF': { label: 'MF', status: 'Operational', color: '#73BF69' }
      };

      // ── Clock & Date ──
      function updateClock() {
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        const ss = String(now.getSeconds()).padStart(2, '0');
        document.getElementById('live-clock').textContent = `${hh}:${mm}:${ss}`;

        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        document.getElementById('live-date').textContent =
          `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;

        const hour = now.getHours();
        const greeting = hour < 12 ? 'Morning' : hour < 17 ? 'Afternoon' : 'Evening';
        document.getElementById('greeting-time').textContent = greeting;
      }
      updateClock();
      setInterval(updateClock, 1000);

      // ── Load all data ──
      const state = window.ElogbookStore ? ElogbookStore.loadState() : { plants: {} };
      const allJobs = [];
      const plantJobCounts = {};

      DEFAULT_PLANTS.forEach(plant => {
        const jobs = (state.plants[plant] && state.plants[plant].jobs) || [];
        plantJobCounts[plant] = { total: jobs.length, completed: 0, inProgress: 0, pending: 0 };
        jobs.forEach(job => {
          allJobs.push({ ...job, _plant: plant });
          if (job.status === '✓ OVER') plantJobCounts[plant].completed++;
          else if (job.status === 'IN PROGRESS') plantJobCounts[plant].inProgress++;
          else plantJobCounts[plant].pending++;
        });
      });

      // ── KPI Stats ──
      const todayIso = new Date().toISOString().slice(0, 10);
      const todayTotalJobs = allJobs.filter(j => (j.targetDate || '').slice(0, 10) === todayIso).length;
      const completedJobs = allJobs.filter(j => j.status === '✓ OVER').length;
      const isoJobs = allJobs.filter(j => String(j.jobType || '').toUpperCase().includes('ISO')).length;
      const normalizeStatus = (status) => String(status || '').trim().toUpperCase();
      const isCompletedStatus = (status) => normalizeStatus(status).includes('OVER');
      const isInProgressStatus = (status) => normalizeStatus(status) === 'IN PROGRESS';
      const completedJobsSafe = allJobs.filter(j => isCompletedStatus(j.status)).length;
      const pendingJobsSafe = allJobs.filter(j => !isCompletedStatus(j.status) && !isInProgressStatus(j.status)).length;
      const pendingJobs = allJobs.filter(j => !j.status || (j.status !== '✓ OVER' && j.status !== 'IN PROGRESS')).length;

      function animateCounter(el, target) {
        if (!el) return;
        let current = 0;
        const step = Math.max(1, Math.ceil(target / 20));
        const interval = setInterval(() => {
          current += step;
          if (current >= target) { current = target; clearInterval(interval); }
          el.textContent = current;
        }, 40);
      }

      setTimeout(() => {
        animateCounter(document.getElementById('kpi-total'), todayTotalJobs);
        animateCounter(document.getElementById('kpi-completed'), completedJobsSafe);
        animateCounter(document.getElementById('kpi-iso'), isoJobs);
        animateCounter(document.getElementById('kpi-pending'), pendingJobsSafe);
      }, 200);


      // ── Plant Badge ──
      let activeCount = 0;
      DEFAULT_PLANTS.forEach(code => {
        const info = PLANT_DISPLAY[code] || { status: 'Unknown' };
        if (info.status !== 'Offline') activeCount++;
      });
      document.getElementById('plant-count-badge').textContent = `${activeCount} Active`;


      // ── Recent Activity Feed ──
      const activityFeed = document.getElementById('activity-feed');
      const recentJobs = allJobs
        .sort((a, b) => new Date(b.updatedAt || b.createdAt).getTime() - new Date(a.updatedAt || a.createdAt).getTime())
        .slice(0, 8);

      if (recentJobs.length === 0) {
        activityFeed.innerHTML = `
        <div class="text-center py-12 color-label">
          <i class="ph ph-clipboard-text text-4xl mb-2 block opacity-30"></i>
          <p class="font-14px fw-bold">No recent activity</p>
        </div>`;
      } else {
        recentJobs.forEach(job => {
          const statusIcon = job.status === '✓ OVER'
            ? '<i class="ph-fill ph-check-circle color-green"></i>'
            : job.status === 'IN PROGRESS'
              ? '<i class="ph-fill ph-hourglass-medium color-orange"></i>'
              : '<i class="ph-fill ph-clock color-red"></i>';

          const statusText = job.status || 'Pending';
          const statusColor = job.status === '✓ OVER' ? 'color-green'
            : job.status === 'IN PROGRESS' ? 'color-orange' : 'color-red';

          const timeAgo = getTimeAgo(new Date(job.updatedAt || job.createdAt));
          const description = job.desc || job.jobType || 'No description';

          activityFeed.innerHTML += `
          <div class="activity-item flex gap-3">
            <div class="w-8 h-8 rounded-full bg-dark-bg border border-dark-border flex items-center justify-center shrink-0 font-15px z-10">
              ${statusIcon}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between gap-2">
                <div class="flex items-center gap-2 min-w-0">
                  <span class="font-14px fw-bold color-blue">${job._plant}</span>
                  <span class="color-label font-13px">•</span>
                  <span class="font-14px fw-bold color-primary truncate">${job.tag || 'N.A'}</span>
                  <span class="font-13px fw-bold ${statusColor} bg-dark-bg px-1.5 py-0.5 rounded-sm border border-dark-border shrink-0">${statusText}</span>
                </div>
                <span class="font-13px color-label font-mono shrink-0">${timeAgo}</span>
              </div>
              <p class="font-14px color-label mt-0.5 truncate">${description}</p>
              <div class="flex items-center gap-3 mt-1">
                <span class="font-13px color-label"><i class="ph ph-user mr-0.5"></i>${job.tech || 'N.A'}</span>
                <span class="font-13px color-label"><i class="ph ph-wrench mr-0.5"></i>${job.jobType || 'N.A'}</span>
              </div>
            </div>
          </div>
        `;
        });
      }

      function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return 'Just now';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        const days = Math.floor(hours / 24);
        return `${days}d ago`;
      }

      // ── Job Distribution Chart ──
      // ── Job Distribution Chart (ApexCharts) ──
      const jobTypeCounts = {};
      allJobs.forEach(job => {
        const type = job.jobType || 'General';
        jobTypeCounts[type] = (jobTypeCounts[type] || 0) + 1;
      });

      const labels = Object.keys(jobTypeCounts);
      const series = Object.values(jobTypeCounts);

      // GNFC Brand Colors safely mapped
      const brandColors = ['#3b82f6', '#10b981', '#f97316', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#6366f1'];

      const options = {
        series: series,
        labels: labels,
        chart: {
          type: 'donut',
          height: 320,
          fontFamily: 'Inter, sans-serif',
          background: 'transparent'
        },
        colors: brandColors,
        plotOptions: {
          pie: {
            donut: {
              size: '70%',
              labels: {
                show: true,
                name: { color: '#94a3b8' },
                value: {
                  color: '#f8fafc',
                  fontSize: '24px',
                  fontWeight: 700,
                  offsetY: 8
                },
                total: {
                  show: true,
                  showAlways: true,
                  label: 'Total Jobs',
                  color: '#94a3b8',
                  formatter: function (w) {
                    return w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                  }
                }
              }
            }
          }
        },
        dataLabels: { enabled: false },
        stroke: { show: true, colors: ['#1e293b'], width: 2 },
        legend: {
          position: 'bottom',
          horizontalAlign: 'center',
          labels: { colors: '#94a3b8' },
          itemMargin: { horizontal: 10, vertical: 5 }
        },
        tooltip: {
          theme: 'dark',
          y: {
            formatter: function (val) {
              return val + " Jobs"
            }
          }
        }
      };

      // Only render if we have data, otherwise show default placeholder
      if (series.length > 0) {
        const chart = new ApexCharts(document.querySelector("#job-distribution-chart"), options);
        chart.render();
      } else {
        document.getElementById('job-distribution-chart').innerHTML =
          '<div class="text-center color-label"><p class="font-15px">No job data available</p></div>';
      }



      // ── Weekly Trends Chart (ApexCharts) ──
      const trendsOptions = {
        series: [{
          name: 'Created',
          data: [12, 18, 15, 25, 20, 32, 28] // Mock data for last 7 days
        }, {
          name: 'Completed',
          data: [10, 15, 12, 20, 22, 28, 25]
        }],
        chart: {
          height: 220,
          type: 'area',
          toolbar: { show: false },
          background: 'transparent',
          fontFamily: 'Inter, sans-serif'
        },
        colors: ['#3b82f6', '#10b981'],
        dataLabels: { enabled: false },
        stroke: { curve: 'smooth', width: 2 },
        xaxis: {
          categories: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
          labels: { style: { colors: '#94a3b8', fontSize: '10px' } },
          axisBorder: { show: false },
          axisTicks: { show: false }
        },
        yaxis: {
          labels: { style: { colors: '#94a3b8', fontSize: '10px' } }
        },
        grid: {
          borderColor: '#334155',
          strokeDashArray: 3,
          yaxis: { lines: { show: true } }
        },
        fill: {
          type: 'gradient',
          gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.05, stops: [0, 90, 100] }
        },
        legend: { show: false }, // Custom legend used
        tooltip: { theme: 'dark' }
      };
      new ApexCharts(document.querySelector("#weekly-trends-chart"), trendsOptions).render();


      // ── Live Plant Status Grid ──
      const plantsStatusContainer = document.getElementById('live-plant-status-list');
      const criticalPlants = ['BOILER', 'M2']; // Mock critical
      const maintenancePlants = ['ANIPF'];     // Mock maintenance

      const topPlants = ['UREA', 'AMM', 'M1', 'M2', 'ANIPF', 'BOILER', 'OFFSITES'];

      topPlants.forEach(plant => {
        let status = 'Operational';
        let statusColor = 'color-green';
        let bgColor = 'bg-gnfc-green/10';
        let icon = 'ph-check-circle';

        if (criticalPlants.includes(plant)) {
          status = 'Critical Alert';
          statusColor = 'color-red';
          bgColor = 'bg-gnfc-red/10';
          icon = 'ph-warning-circle';
        } else if (maintenancePlants.includes(plant)) {
          status = 'Maintenance';
          statusColor = 'color-orange';
          bgColor = 'bg-gnfc-orange/10';
          icon = 'ph-wrench';
        }

        plantsStatusContainer.innerHTML += `
            <div class="flex items-center justify-between p-2 rounded-md bg-dark-bg/50 border border-dark-border hover:border-dark-border/80 transition-colors">
               <div class="flex items-center gap-3">
                  <div class="w-8 h-8 rounded-md ${bgColor} flex items-center justify-center ${statusColor}">
                     <i class="ph-fill ${icon} text-lg"></i>
                  </div>
                  <div>
                     <div class="font-14px fw-bold color-white">${plant}</div>
                     <div class="font-13px color-label">${status}</div>
                  </div>
               </div>
               <div class="text-right">
                  <div class="font-13px font-mono fw-bold color-primary">98%</div>
                  <div class="font-12px color-label text-upper">Eff.</div>
               </div>
            </div>
          `;
      });

      // ── Upcoming Schedules Widget ──
      const schedulesContainer = document.getElementById('upcoming-schedules-list');
      const schedules = [
        { title: 'PM: Ammonia Comp A', due: '2h', type: 'PM', color: 'gnfc-blue' },
        { title: 'Calib: PT-1002 (Urea)', due: '5h', type: 'CALIB', color: 'gnfc-purple' },
        { title: 'Safety Loop Check', due: 'Tomorrow', type: 'TEST', color: 'gnfc-orange' },
      ];

      if (schedules.length === 0) {
        schedulesContainer.innerHTML = '<p class="font-13px color-label text-center py-2">No upcoming schedules</p>';
      } else {
        schedules.forEach(item => {
          schedulesContainer.innerHTML += `
               <div class="flex items-center gap-2 p-2 rounded bg-dark-bg/30 border-l-2 border-${item.color}">
                  <div class="flex-1 min-w-0">
                     <div class="font-14px fw-bold color-primary truncate">${item.title}</div>
                     <div class="font-12px color-label font-mono text-upper ls-wide">${item.type}</div>
                  </div>
                  <div class="bg-dark-panel border border-dark-border px-1.5 py-0.5 rounded font-13px fw-bold text-${item.color}">
                     ${item.due}
                  </div>
               </div>
            `;
        });
      }

      // ── Quick Actions Badges ──
      const sypmCount = allJobs.filter(j => (j.area === 'SY' || j.area === 'PM') && !isCompletedStatus(j.status)).length;
      if (sypmCount > 0) {
          const el = document.getElementById('qa-sypm-badge');
          if (el) {
              el.classList.remove('hidden');
          }
      }

      if (pendingJobsSafe > 0) {
          const el = document.getElementById('qa-pending-badge');
          if (el) {
              el.textContent = pendingJobsSafe > 99 ? '99+' : pendingJobsSafe;
              el.classList.remove('hidden');
          }
      }

    })();
  </script>
</body>

</html>
