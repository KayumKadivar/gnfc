<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | GNFC E-Logbook</title>
  <link rel="stylesheet" href="/src/css/ios-fonts.css">
  <link rel="stylesheet" href="/src/css/modal-ui.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="/src/js/tailwind_config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script>window.activePage = 'dashboard';</script>
  <style>
    /* Animated gradient border for KPI cards */
    .kpi-card {
      position: relative;
      overflow: hidden;
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--kpi-color, #5794F2);
      opacity: 0.8;
      transition: opacity 0.3s;
    }

    .kpi-card:hover::before {
      opacity: 1;
    }

    /* Pulse dot animation */
    @keyframes pulse-dot {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: 0.5;
        transform: scale(1.4);
      }
    }

    .pulse-dot {
      animation: pulse-dot 2s ease-in-out infinite;
    }

    /* Activity timeline */
    .activity-item {
      position: relative;
    }

    .activity-item::before {
      content: '';
      position: absolute;
      left: 15px;
      top: 32px;
      bottom: -12px;
      width: 1px;
      background: var(--app-border, #2c3235);
    }

    .activity-item:last-child::before {
      display: none;
    }

    /* Counter animation */
    .counter-value {
      transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Bar chart animation */
    .chart-bar {
      transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Glassmorphism quick-action */
    .quick-action {
      backdrop-filter: blur(8px);
      transition: all 0.25s ease;
    }

    .quick-action:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    /* Smooth scrollbar */
    .dashboard-scroll::-webkit-scrollbar {
      width: 4px;
    }

    .dashboard-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .dashboard-scroll::-webkit-scrollbar-thumb {
      background: #2c3235;
      border-radius: 4px;
    }

    .dashboard-scroll::-webkit-scrollbar-thumb:hover {
      background: #5794F2;
    }
  </style>
</head>

<body class="bg-dark-bg color-primary font-sans h-screen flex overflow-hidden">

  <script src="/src/js/theme_manager.js"></script>
  <script src="/src/js/sidebar.js"></script>
  <script src="/src/js/elogbook_store.js"></script>
  <script src="/src/js/notification_manager.js"></script>
  <script src="/src/js/calibration_store.js"></script>
  <script src="/src/js/modals/calibration_due_modal.js?v=20260223c"></script>
  <div id="sidebar-container"></div>
  <script>renderSidebar('dashboard');</script>

  <main class="flex-1 flex flex-col h-screen overflow-hidden">

    <div id="header-container"></div>
    <script src="/src/js/header.js"></script>
    <script>
      renderHeader({
        title: "Dashboard",
        breadcrumbs: [
          { label: "Dashboard" }
        ],
        backLink: "/index.html"
      });
    </script>

    <!-- ═══════ SCROLLABLE CONTENT ═══════ -->
    <div class="flex-1 overflow-y-auto p-4 bg-dark-bg dashboard-scroll space-y-5">

      <!-- ─── Top Bar: Welcome + Clock ─── -->
      <div class="flex items-center justify-between">
        <div>
          <h2 class="font-18px fw-bold tracking-tight">Good <span id="greeting-time">Morning</span>, Admin
          </h2>
          <p class="font-14px color-label mt-0.5">Plant operations overview for today</p>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2 bg-dark-panel border border-dark-border rounded-md px-3 py-2 shadow-sm">
            <i class="ph ph-calendar-blank color-blue"></i>
            <span id="live-date" class="font-14px font-mono fw-bold color-primary">--</span>
          </div>
          <div class="flex items-center gap-2 bg-dark-panel border border-dark-border rounded-md px-3 py-2 shadow-sm">
            <i class="ph ph-clock color-orange"></i>
            <span id="live-clock" class="font-14px font-mono fw-bold color-primary tabular-nums">--:--:--</span>
          </div>
        </div>
      </div>

      <!-- ─── STATUS & ALERTS PANEL ─── -->
      <div id="dashboard-notifications-panel" class="mb-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-14px fw-black color-primary uppercase tracking-widest ls-wider flex items-center gap-2">
            <i class="ph-bold ph-bell-ringing color-red"></i>
            Active Alerts & Notications
          </h2>
          <button onclick="NotificationManager.clearAll()"
            class="font-10px fw-extrabold color-label hover-color-primary uppercase tracking-widest transition-colors">Clear
            All</button>
        </div>

        <div id="dashboard-notifications-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- Notifications injected here -->
        </div>
      </div>

      <!-- ─── KPI STAT CARDS ─── -->
      <div class="grid grid-cols-2 lg:grid-cols-5 gap-3">

        <!-- Calibration Due (New) -->
        <div id="kpi-card-cal"
          class="kpi-card bg-dark-panel border border-dark-border rounded-md p-4 transition-all cursor-pointer shadow-sm group hidden"
          style="--kpi-color: #F2495C" onclick="window.CalibrationModal && CalibrationModal.show('manual')">
          <div class="flex items-center justify-between mb-3">
            <div
              class="w-9 h-9 rounded-lg bg-gnfc-red/10 flex items-center justify-center group-hover:bg-gnfc-red/20 transition-colors">
              <i class="ph-fill ph-warning-diamond text-lg color-red"></i>
            </div>
            <span class="font-13px fw-bold color-red animate-pulse">ACTION</span>
          </div>
          <div class="typo-kpi counter-value" id="kpi-cal-count">0</div>
          <p class="font-13px color-label fw-bold mt-1 text-upper ls-wide">Calibration Due</p>
        </div>

        <!-- Today Total Jobs -->
        <div
          class="kpi-card bg-dark-panel border border-dark-border rounded-md p-4 hover:border-gnfc-blue/40 transition-all cursor-default shadow-sm"
          style="--kpi-color: #5794F2">
          <div class="flex items-center justify-between mb-3">
            <div class="w-9 h-9 rounded-lg bg-gnfc-blue/10 flex items-center justify-center">
              <i class="ph-fill ph-briefcase text-lg color-blue"></i>
            </div>
            <span class="font-13px fw-bold color-label text-upper ls-wider">Today</span>
          </div>
          <div class="typo-kpi counter-value" id="kpi-total">0</div>
          <p class="font-13px color-label fw-bold mt-1 text-upper ls-wide">Today Total Jobs</p>
        </div>

        <!-- Completed Jobs -->
        <div
          class="kpi-card bg-dark-panel border border-dark-border rounded-md p-4 hover:border-gnfc-green/40 transition-all cursor-default shadow-sm"
          style="--kpi-color: #73BF69">
          <div class="flex items-center justify-between mb-3">
            <div class="w-9 h-9 rounded-lg bg-gnfc-green/10 flex items-center justify-center">
              <i class="ph-fill ph-check-circle text-lg color-green"></i>
            </div>
            <i class="ph-fill ph-checks color-green font-14px"></i>
          </div>
          <div class="typo-kpi counter-value" id="kpi-completed">0</div>
          <p class="font-13px color-label fw-bold mt-1 text-upper ls-wide">Completed Jobs</p>
        </div>

        <!-- ISO Jobs -->
        <div
          class="kpi-card bg-dark-panel border border-dark-border rounded-md p-4 hover:border-gnfc-orange/40 transition-all cursor-default shadow-sm"
          style="--kpi-color: #FF9900">
          <div class="flex items-center justify-between mb-3">
            <div class="w-9 h-9 rounded-lg bg-gnfc-orange/10 flex items-center justify-center">
              <i class="ph-fill ph-certificate text-lg color-orange"></i>
            </div>
            <span class="font-13px fw-bold color-orange bg-gnfc-orange/10 px-1.5 py-0.5 rounded-sm">ISO</span>
          </div>
          <div class="typo-kpi counter-value" id="kpi-iso">0</div>
          <p class="font-13px color-label fw-bold mt-1 text-upper ls-wide">ISO Jobs</p>
        </div>

        <!-- All Pending Jobs -->
        <div
          class="kpi-card bg-dark-panel border border-dark-border rounded-md p-4 hover:border-gnfc-red/40 transition-all cursor-default shadow-sm"
          style="--kpi-color: #F2495C">
          <div class="flex items-center justify-between mb-3">
            <div class="w-9 h-9 rounded-lg bg-gnfc-red/10 flex items-center justify-center">
              <i class="ph-fill ph-warning-circle text-lg color-red"></i>
            </div>
            <i class="ph-fill ph-arrow-down color-red font-14px"></i>
          </div>
          <div class="typo-kpi counter-value" id="kpi-pending">0</div>
          <p class="font-13px color-label fw-bold mt-1 text-upper ls-wide">All Pending Jobs</p>
        </div>
      </div>

      <!-- ─── NOTICEBOARD SECTION ─── -->
      <div class="mt-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-14px fw-black color-primary uppercase tracking-widest ls-wider flex items-center gap-2">
            <i class="ph-bold ph-megaphone color-blue"></i>
            Important Announcements
          </h2>
          <button
            class="bg-gnfc-blue/10 hover:bg-gnfc-blue/20 color-blue px-3 py-1.5 rounded-md font-11px fw-bold transition-all flex items-center gap-2">
            <i class="ph-bold ph-plus"></i>
            Post Notice
          </button>
        </div>
        <div id="noticeboard-container" class="grid grid-cols-1 md:grid-cols-3 gap-5">
          <!-- Notices injected here -->
        </div>
      </div>


    </div>
  </main>

  <!-- ═══════ DASHBOARD LOGIC ═══════ -->
  <script>
    (function () {
      'use strict';

      const DEFAULT_PLANTS = [
        'AA', 'AAQM', 'AMM', 'ANIPF', 'ANITDI',
        'ASGP', 'BAGG', 'BOILER', 'CMS', 'CPSU',
        'DM', 'EA', 'FA', 'INST WS', 'M1', 'M2', 'UREA', 'UTIL', 'DCS', 'MF'
      ];

      const PLANT_DISPLAY = {
        'AA': { label: 'AA Section', status: 'Operational', color: '#73BF69' },
        'AAQM': { label: 'AAQM', status: 'Operational', color: '#73BF69' },
        'AMM': { label: 'Ammonia', status: 'Operational', color: '#73BF69' },
        'ANIPF': { label: 'ANIPF', status: 'Maintenance', color: '#FF9900' },
        'ANITDI': { label: 'ANITDI', status: 'Operational', color: '#73BF69' },
        'ASGP': { label: 'ASGP', status: 'Operational', color: '#73BF69' },
        'BAGG': { label: 'Bagging', status: 'Operational', color: '#73BF69' },
        'BOILER': { label: 'BOILER', status: 'Critical', color: '#F2495C' },
        'CMS': { label: 'CMS', status: 'Operational', color: '#73BF69' },
        'CPSU': { label: 'CPSU', status: 'Operational', color: '#73BF69' },
        'DM': { label: 'DM Plant', status: 'Operational', color: '#73BF69' },
        'EA': { label: 'EA', status: 'Operational', color: '#73BF69' },
        'FA': { label: 'FA Section', status: 'Operational', color: '#73BF69' },
        'INST WS': { label: 'Inst W/S', status: 'Active', color: '#5794F2' },
        'M1': { label: 'Methanol-1', status: 'Operational', color: '#73BF69' },
        'M2': { label: 'Methanol-2', status: 'Maintenance', color: '#FF9900' },
        'UREA': { label: 'Urea', status: 'Operational', color: '#73BF69' },
        'UTIL': { label: 'Utility', status: 'Operational', color: '#73BF69' },
        'DCS': { label: 'DCS', status: 'Active', color: '#5794F2' },
        'MF': { label: 'MF', status: 'Operational', color: '#73BF69' }
      };

      // ── Clock & Date ──
      function updateClock() {
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        const ss = String(now.getSeconds()).padStart(2, '0');
        document.getElementById('live-clock').textContent = `${hh}:${mm}:${ss}`;

        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        document.getElementById('live-date').textContent =
          `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;

        const hour = now.getHours();
        const greeting = hour < 12 ? 'Morning' : hour < 17 ? 'Afternoon' : 'Evening';
        document.getElementById('greeting-time').textContent = greeting;
      }
      updateClock();
      setInterval(updateClock, 1000);

      // ── Load all data ──
      const state = window.ElogbookStore ? ElogbookStore.loadState() : { plants: {} };
      const allJobs = [];
      const plantJobCounts = {};

      DEFAULT_PLANTS.forEach(plant => {
        const jobs = (state.plants[plant] && state.plants[plant].jobs) || [];
        plantJobCounts[plant] = { total: jobs.length, completed: 0, inProgress: 0, pending: 0 };
        jobs.forEach(job => {
          allJobs.push({ ...job, _plant: plant });
          if (job.status === '✓ OVER') plantJobCounts[plant].completed++;
          else if (job.status === 'IN PROGRESS') plantJobCounts[plant].inProgress++;
          else plantJobCounts[plant].pending++;
        });
      });

      // ── KPI Stats ──
      const todayIso = new Date().toISOString().slice(0, 10);
      const todayTotalJobs = allJobs.filter(j => (j.targetDate || '').slice(0, 10) === todayIso).length;
      const completedJobs = allJobs.filter(j => j.status === '✓ OVER').length;
      const isoJobs = allJobs.filter(j => String(j.jobType || '').toUpperCase().includes('ISO')).length;
      const normalizeStatus = (status) => String(status || '').trim().toUpperCase();
      const isCompletedStatus = (status) => normalizeStatus(status).includes('OVER');
      const isInProgressStatus = (status) => normalizeStatus(status) === 'IN PROGRESS';
      const completedJobsSafe = allJobs.filter(j => isCompletedStatus(j.status)).length;
      const pendingJobsSafe = allJobs.filter(j => !isCompletedStatus(j.status) && !isInProgressStatus(j.status)).length;

      // ── Calibration Stats ──
      const calDueItems = window.CalibrationStore ? CalibrationStore.getDueItems() : [];
      const calCount = calDueItems.length;

      function animateCounter(el, target) {
        if (!el) return;
        let current = 0;
        const step = Math.max(1, Math.ceil(target / 20));
        const interval = setInterval(() => {
          current += step;
          if (current >= target) { current = target; clearInterval(interval); }
          el.textContent = current;
        }, 40);
      }

      setTimeout(() => {
        animateCounter(document.getElementById('kpi-total'), todayTotalJobs);
        animateCounter(document.getElementById('kpi-completed'), completedJobsSafe);
        animateCounter(document.getElementById('kpi-iso'), isoJobs);
        animateCounter(document.getElementById('kpi-pending'), pendingJobsSafe);

        if (calCount > 0) {
          const calCard = document.getElementById('kpi-card-cal');
          calCard.classList.remove('hidden');
          animateCounter(document.getElementById('kpi-cal-count'), calCount);
        }
      }, 200);

      // ── Noticeboard Logic ──
      const notices = [
        {
          id: 1,
          title: "Plant Shutdown Schedule - Q2",
          content: "Please note the updated maintenance schedule for the Ammonia plant starting April 15th.",
          author: "Plant Manager",
          date: "23 Feb 2026",
          priority: "urgent",
          pinned: true
        },
        {
          id: 2,
          title: "Safety Drill Today",
          content: "Standard safety drill scheduled for 14:00 today. All personnel must report to designated assembly points.",
          author: "Safety Officer",
          date: "23 Feb 2026",
          priority: "normal",
          pinned: false
        },
        {
          id: 3,
          title: "New Instrument Calibration Kit",
          content: "Newly received Fluke 754 calibrators are now available in the workshop for checkout.",
          author: "Workshop In-charge",
          date: "22 Feb 2026",
          priority: "important",
          pinned: false
        }
      ];

      function renderNoticeboard() {
        const container = document.getElementById('noticeboard-container');
        if (!container) return;

        container.innerHTML = notices.map(notice => {
          const priorityClass = notice.priority === 'urgent' ? 'border-l-4 border-red-500 bg-red-500/5' :
            notice.priority === 'important' ? 'border-l-4 border-orange-500 bg-orange-500/5' :
              'border-l-4 border-blue-500 bg-blue-500/5';

          const pinIcon = notice.pinned ? '<i class="ph-fill ph-push-pin color-orange font-14px"></i>' : '';

          return `
            <div class="bg-dark-panel border border-dark-border rounded-lg p-4 shadow-sm hover:shadow-md transition-all group ${priorityClass} cursor-pointer hover:border-blue-500/50" onclick="openNoticeModal(${notice.id})">
              <div class="flex items-start justify-between mb-2 gap-3">
                <h3 class="font-15px fw-bold color-primary group-hover:color-blue transition-colors leading-tight">${notice.title}</h3>
                <div class="shrink-0 mt-0.5">${pinIcon}</div>
              </div>
              <p class="font-14px color-label leading-relaxed mb-4 line-clamp-2">${notice.content}</p>
              <div class="flex items-center justify-between border-t border-dark-border/50 pt-3">
                <div class="flex items-center gap-1.5 text-xs color-secondary">
                  <i class="ph ph-user"></i>
                  <span>${notice.author}</span>
                </div>
                <div class="flex items-center gap-1.5 text-xs color-secondary font-mono">
                  <i class="ph ph-calendar"></i>
                  <span>${notice.date}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      renderNoticeboard();

      // ── Notice Modal Logic ──
      window.openNoticeModal = function (id) {
        const notice = notices.find(n => n.id === id);
        if (!notice) return;

        const modalHtml = `
          <div id="notice-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200" onclick="if(event.target === this) this.remove()">
            <div class="bg-dark-panel border border-dark-border w-full max-w-lg rounded-xl shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200">
              <div class="p-6 border-b border-dark-border flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-lg bg-gnfc-blue/10 flex items-center justify-center">
                    <i class="ph-fill ph-megaphone color-blue text-xl"></i>
                  </div>
                  <div>
                    <h2 class="font-16px fw-bold color-primary">${notice.title}</h2>
                    <p class="font-12px color-label mt-0.5">Announcement Details</p>
                  </div>
                </div>
                <button onclick="document.getElementById('notice-modal').remove()" class="w-8 h-8 rounded-full hover:bg-white/5 flex items-center justify-center transition-colors">
                  <i class="ph ph-x color-secondary font-18px"></i>
                </button>
              </div>
              <div class="p-6">
                <div class="bg-dark-bg/50 border border-dark-border rounded-lg p-4 mb-6">
                  <p class="font-15px color-primary leading-relaxed">${notice.content}</p>
                </div>
                <div class="flex items-center justify-between bg-white/2 rounded-lg px-4 py-3">
                  <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-dark-border flex items-center justify-center">
                      <i class="ph-fill ph-user-circle color-secondary text-lg"></i>
                    </div>
                    <div>
                      <p class="font-12px fw-bold color-primary">${notice.author}</p>
                      <p class="font-10px color-label uppercase tracking-wider ls-wide">Posted By</p>
                    </div>
                  </div>
                  <div class="text-right">
                    <p class="font-12px fw-bold color-primary font-mono">${notice.date}</p>
                    <p class="font-10px color-label uppercase tracking-wider ls-wide">Date</p>
                  </div>
                </div>
              </div>
              <div class="p-4 bg-white/2 border-t border-dark-border flex justify-end">
                <button onclick="document.getElementById('notice-modal').remove()" class="bg-gnfc-blue hover:bg-blue-600 color-white px-6 py-2 rounded-md font-13px fw-bold transition-all shadow-md active:scale-95">
                  Understood
                </button>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      }


    })();
  </script>
</body>

</html>