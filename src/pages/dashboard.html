<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | GNFC E-Logbook</title>
  <link rel="stylesheet" href="/src/css/ios-fonts.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="/src/js/tailwind_config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script>window.activePage = 'dashboard';</script>
  <style>
    /* Animated gradient border for KPI cards */
    .kpi-card {
      position: relative;
      overflow: hidden;
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--kpi-color, #5794F2);
      opacity: 0.8;
      transition: opacity 0.3s;
    }

    .kpi-card:hover::before {
      opacity: 1;
    }

    /* Pulse dot animation */
    @keyframes pulse-dot {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: 0.5;
        transform: scale(1.4);
      }
    }

    .pulse-dot {
      animation: pulse-dot 2s ease-in-out infinite;
    }

    /* Activity timeline */
    .activity-item {
      position: relative;
    }

    .activity-item::before {
      content: '';
      position: absolute;
      left: 15px;
      top: 32px;
      bottom: -12px;
      width: 1px;
      background: var(--app-border, #2c3235);
    }

    .activity-item:last-child::before {
      display: none;
    }

    /* Counter animation */
    .counter-value {
      transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Bar chart animation */
    .chart-bar {
      transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Glassmorphism quick-action */
    .quick-action {
      backdrop-filter: blur(8px);
      transition: all 0.25s ease;
    }

    .quick-action:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    /* Smooth scrollbar */
    .dashboard-scroll::-webkit-scrollbar {
      width: 4px;
    }

    .dashboard-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .dashboard-scroll::-webkit-scrollbar-thumb {
      background: #2c3235;
      border-radius: 4px;
    }

    .dashboard-scroll::-webkit-scrollbar-thumb:hover {
      background: #5794F2;
    }
  </style>
</head>

<body class="bg-dark-bg color-primary font-sans h-screen flex overflow-hidden">

  <script src="/src/js/theme_manager.js"></script>
  <script src="/src/js/sidebar.js"></script>
  <script src="/src/js/elogbook_store.js"></script>
  <div id="sidebar-container"></div>
  <script>renderSidebar('dashboard');</script>

  <main class="flex-1 flex flex-col h-screen overflow-hidden">

    <div id="header-container"></div>
    <script src="/src/js/header.js"></script>
    <script>
      renderHeader({
        title: "Dashboard",
        breadcrumbs: [
          { label: "Dashboard" }
        ],
        backLink: "/index.html"
      });
    </script>

    <!-- ═══════ SCROLLABLE CONTENT ═══════ -->
    <div class="flex-1 overflow-y-auto p-4 bg-dark-bg dashboard-scroll space-y-5">

      <!-- ─── Top Bar: Welcome + Clock ─── -->
      <div class="flex items-center justify-between">
        <div>
          <h2 class="font-18px fw-bold tracking-tight">Good <span id="greeting-time">Morning</span>, Admin
          </h2>
          <p class="font-14px color-label mt-0.5">Plant operations overview for today</p>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2 bg-dark-panel border border-dark-border rounded-md px-3 py-2 shadow-md">
            <i class="ph ph-calendar-blank color-blue"></i>
            <span id="live-date" class="font-14px font-mono fw-bold color-primary">--</span>
          </div>
          <div class="flex items-center gap-2 bg-dark-panel border border-dark-border rounded-md px-3 py-2 shadow-md">
            <i class="ph ph-clock color-orange"></i>
            <span id="live-clock" class="font-14px font-mono fw-bold color-primary tabular-nums">--:--:--</span>
          </div>
        </div>
      </div>

      <!-- ─── KPI STAT CARDS ─── -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">

        <!-- Today Total Jobs -->
        <div
          class="kpi-card bg-dark-panel border border-dark-border rounded-md p-4 hover:border-gnfc-blue/40 transition-all cursor-default shadow-md"
          style="--kpi-color: #5794F2">
          <div class="flex items-center justify-between mb-3">
            <div class="w-9 h-9 rounded-lg bg-gnfc-blue/10 flex items-center justify-center">
              <i class="ph-fill ph-briefcase text-lg color-blue"></i>
            </div>
            <span class="font-13px fw-bold color-label text-upper ls-wider">Today</span>
          </div>
          <div class="typo-kpi counter-value" id="kpi-total">0</div>
          <p class="font-13px color-label fw-bold mt-1 text-upper ls-wide">Today Total Jobs</p>
        </div>

        <!-- Completed Jobs -->
        <div
          class="kpi-card bg-dark-panel border border-dark-border rounded-md p-4 hover:border-gnfc-green/40 transition-all cursor-default shadow-md"
          style="--kpi-color: #73BF69">
          <div class="flex items-center justify-between mb-3">
            <div class="w-9 h-9 rounded-lg bg-gnfc-green/10 flex items-center justify-center">
              <i class="ph-fill ph-check-circle text-lg color-green"></i>
            </div>
            <i class="ph-fill ph-checks color-green font-14px"></i>
          </div>
          <div class="typo-kpi counter-value" id="kpi-completed">0</div>
          <p class="font-13px color-label fw-bold mt-1 text-upper ls-wide">Completed Jobs</p>
        </div>

        <!-- ISO Jobs -->
        <div
          class="kpi-card bg-dark-panel border border-dark-border rounded-md p-4 hover:border-gnfc-orange/40 transition-all cursor-default shadow-md"
          style="--kpi-color: #FF9900">
          <div class="flex items-center justify-between mb-3">
            <div class="w-9 h-9 rounded-lg bg-gnfc-orange/10 flex items-center justify-center">
              <i class="ph-fill ph-certificate text-lg color-orange"></i>
            </div>
            <span class="font-13px fw-bold color-orange bg-gnfc-orange/10 px-1.5 py-0.5 rounded-sm">ISO</span>
          </div>
          <div class="typo-kpi counter-value" id="kpi-iso">0</div>
          <p class="font-13px color-label fw-bold mt-1 text-upper ls-wide">ISO Jobs</p>
        </div>

        <!-- All Pending Jobs -->
        <div
          class="kpi-card bg-dark-panel border border-dark-border rounded-md p-4 hover:border-gnfc-red/40 transition-all cursor-default shadow-md"
          style="--kpi-color: #F2495C">
          <div class="flex items-center justify-between mb-3">
            <div class="w-9 h-9 rounded-lg bg-gnfc-red/10 flex items-center justify-center">
              <i class="ph-fill ph-warning-circle text-lg color-red"></i>
            </div>
            <i class="ph-fill ph-arrow-down color-red font-14px"></i>
          </div>
          <div class="typo-kpi counter-value" id="kpi-pending">0</div>
          <p class="font-13px color-label fw-bold mt-1 text-upper ls-wide">All Pending Jobs</p>
        </div>
      </div>


    </div>
  </main>

  <!-- ═══════ DASHBOARD LOGIC ═══════ -->
  <script>
    (function () {
      'use strict';

      const DEFAULT_PLANTS = [
        'AA', 'AAQM', 'AMM', 'ANIPF', 'ANITDI',
        'ASGP', 'BAGG', 'BOILER', 'CMS', 'CPSU',
        'DM', 'EA', 'FA', 'INST WS', 'M1', 'M2', 'UREA', 'UTIL', 'DCS', 'MF'
      ];

      const PLANT_DISPLAY = {
        'AA': { label: 'AA Section', status: 'Operational', color: '#73BF69' },
        'AAQM': { label: 'AAQM', status: 'Operational', color: '#73BF69' },
        'AMM': { label: 'Ammonia', status: 'Operational', color: '#73BF69' },
        'ANIPF': { label: 'ANIPF', status: 'Maintenance', color: '#FF9900' },
        'ANITDI': { label: 'ANITDI', status: 'Operational', color: '#73BF69' },
        'ASGP': { label: 'ASGP', status: 'Operational', color: '#73BF69' },
        'BAGG': { label: 'Bagging', status: 'Operational', color: '#73BF69' },
        'BOILER': { label: 'BOILER', status: 'Critical', color: '#F2495C' },
        'CMS': { label: 'CMS', status: 'Operational', color: '#73BF69' },
        'CPSU': { label: 'CPSU', status: 'Operational', color: '#73BF69' },
        'DM': { label: 'DM Plant', status: 'Operational', color: '#73BF69' },
        'EA': { label: 'EA', status: 'Operational', color: '#73BF69' },
        'FA': { label: 'FA Section', status: 'Operational', color: '#73BF69' },
        'INST WS': { label: 'Inst W/S', status: 'Active', color: '#5794F2' },
        'M1': { label: 'Methanol-1', status: 'Operational', color: '#73BF69' },
        'M2': { label: 'Methanol-2', status: 'Maintenance', color: '#FF9900' },
        'UREA': { label: 'Urea', status: 'Operational', color: '#73BF69' },
        'UTIL': { label: 'Utility', status: 'Operational', color: '#73BF69' },
        'DCS': { label: 'DCS', status: 'Active', color: '#5794F2' },
        'MF': { label: 'MF', status: 'Operational', color: '#73BF69' }
      };

      // ── Clock & Date ──
      function updateClock() {
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        const ss = String(now.getSeconds()).padStart(2, '0');
        document.getElementById('live-clock').textContent = `${hh}:${mm}:${ss}`;

        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        document.getElementById('live-date').textContent =
          `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;

        const hour = now.getHours();
        const greeting = hour < 12 ? 'Morning' : hour < 17 ? 'Afternoon' : 'Evening';
        document.getElementById('greeting-time').textContent = greeting;
      }
      updateClock();
      setInterval(updateClock, 1000);

      // ── Load all data ──
      const state = window.ElogbookStore ? ElogbookStore.loadState() : { plants: {} };
      const allJobs = [];
      const plantJobCounts = {};

      DEFAULT_PLANTS.forEach(plant => {
        const jobs = (state.plants[plant] && state.plants[plant].jobs) || [];
        plantJobCounts[plant] = { total: jobs.length, completed: 0, inProgress: 0, pending: 0 };
        jobs.forEach(job => {
          allJobs.push({ ...job, _plant: plant });
          if (job.status === '✓ OVER') plantJobCounts[plant].completed++;
          else if (job.status === 'IN PROGRESS') plantJobCounts[plant].inProgress++;
          else plantJobCounts[plant].pending++;
        });
      });

      // ── KPI Stats ──
      const todayIso = new Date().toISOString().slice(0, 10);
      const todayTotalJobs = allJobs.filter(j => (j.targetDate || '').slice(0, 10) === todayIso).length;
      const completedJobs = allJobs.filter(j => j.status === '✓ OVER').length;
      const isoJobs = allJobs.filter(j => String(j.jobType || '').toUpperCase().includes('ISO')).length;
      const normalizeStatus = (status) => String(status || '').trim().toUpperCase();
      const isCompletedStatus = (status) => normalizeStatus(status).includes('OVER');
      const isInProgressStatus = (status) => normalizeStatus(status) === 'IN PROGRESS';
      const completedJobsSafe = allJobs.filter(j => isCompletedStatus(j.status)).length;
      const pendingJobsSafe = allJobs.filter(j => !isCompletedStatus(j.status) && !isInProgressStatus(j.status)).length;
      const pendingJobs = allJobs.filter(j => !j.status || (j.status !== '✓ OVER' && j.status !== 'IN PROGRESS')).length;

      function animateCounter(el, target) {
        if (!el) return;
        let current = 0;
        const step = Math.max(1, Math.ceil(target / 20));
        const interval = setInterval(() => {
          current += step;
          if (current >= target) { current = target; clearInterval(interval); }
          el.textContent = current;
        }, 40);
      }

      setTimeout(() => {
        animateCounter(document.getElementById('kpi-total'), todayTotalJobs);
        animateCounter(document.getElementById('kpi-completed'), completedJobsSafe);
        animateCounter(document.getElementById('kpi-iso'), isoJobs);
        animateCounter(document.getElementById('kpi-pending'), pendingJobsSafe);
      }, 200);




      // ── Quick Actions Badges ──
      const sypmCount = allJobs.filter(j => (j.area === 'SY' || j.area === 'PM') && !isCompletedStatus(j.status)).length;
      if (sypmCount > 0) {
        const el = document.getElementById('qa-sypm-badge');
        if (el) {
          el.classList.remove('hidden');
        }
      }

      if (pendingJobsSafe > 0) {
        const el = document.getElementById('qa-pending-badge');
        if (el) {
          el.textContent = pendingJobsSafe > 99 ? '99+' : pendingJobsSafe;
          el.classList.remove('hidden');
        }
      }

    })();
  </script>
</body>

</html>